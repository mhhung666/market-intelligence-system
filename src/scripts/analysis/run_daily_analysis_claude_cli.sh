#!/usr/bin/env bash
###############################################################################
# Market Intelligence System - Daily Analysis V2 (Dual Reports)
#
# ç”Ÿæˆå…©å€‹ç¨ç«‹çš„åˆ†æå ±å‘Š:
# 1. å¸‚å ´åˆ†æå ±å‘Š (market-analysis-{date}.md) - å°ˆæ³¨å…¨çƒå¸‚å ´è¶¨å‹¢å’Œæ–°è
# 2. æŒå€‰åˆ†æå ±å‘Š (holdings-analysis-{date}.md) - å°ˆæ³¨æŠ•è³‡çµ„åˆå’ŒæŒè‚¡è¡¨ç¾
#
# ä¾è³´:
#   - claude CLI (npm install -g @anthropic-ai/claude-cli)
#   - å·²ç™»å…¥ Claude CLI (claude login)
#
# ä½¿ç”¨æ–¹å¼:
#   ./src/scripts/analysis/run_daily_analysis_claude_cli.sh
###############################################################################

set -e  # é‡åˆ°éŒ¯èª¤ç«‹å³é€€å‡º

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥æœŸ
TODAY=$(date +"%Y-%m-%d")
YEAR=$(date +"%Y")

# è·¯å¾‘
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../.." && pwd)"
OUTPUT_DIR="${PROJECT_ROOT}/output/market-data/${YEAR}"
DAILY_DIR="${OUTPUT_DIR}/Daily"
NEWS_DIR="${OUTPUT_DIR}/News"
REPORTS_DIR="${PROJECT_ROOT}/reports/markdown"
CONFIG_DIR="${PROJECT_ROOT}/config"

# æª”æ¡ˆè·¯å¾‘
GLOBAL_INDICES="${DAILY_DIR}/global-indices-${TODAY}.md"
PRICES="${DAILY_DIR}/holdings-prices-${TODAY}.md"
HOLDINGS_CONFIG="${CONFIG_DIR}/holdings.yaml"
PORTFOLIO_HOLDINGS="${PROJECT_ROOT}/../financial-analysis-system/portfolio/${YEAR}/holdings.md"
MARKET_ANALYSIS_OUTPUT="${REPORTS_DIR}/market-analysis-${TODAY}.md"
HOLDINGS_ANALYSIS_OUTPUT="${REPORTS_DIR}/holdings-analysis-${TODAY}.md"
MARKET_PROMPT_FILE="/tmp/market-analysis-prompt-${TODAY}.txt"
HOLDINGS_PROMPT_FILE="/tmp/holdings-analysis-prompt-${TODAY}.txt"

###############################################################################
# å‡½æ•¸å®šç¾©
###############################################################################

print_header() {
    echo -e "${BLUE}============================================================${NC}"
    echo -e "${BLUE}ğŸ“Š Market Intelligence System - æ¯æ—¥é›™å ±å‘Šåˆ†æ${NC}"
    echo -e "${BLUE}============================================================${NC}"
    echo ""
    echo -e "${GREEN}ğŸ“… åˆ†ææ—¥æœŸ: ${TODAY}${NC}"
    echo -e "${GREEN}ğŸ“„ å ±å‘Š 1: å¸‚å ´åˆ†æ (market-analysis-${TODAY}.md)${NC}"
    echo -e "${GREEN}ğŸ“„ å ±å‘Š 2: æŒå€‰åˆ†æ (holdings-analysis-${TODAY}.md)${NC}"
    echo ""
}

check_dependencies() {
    echo -e "${BLUE}ğŸ” æª¢æŸ¥ä¾è³´...${NC}"

    # æª¢æŸ¥ claude CLI
    CLAUDE_BIN=""
    if command -v claude &> /dev/null; then
        CLAUDE_BIN="claude"
    elif [[ -x "${HOME}/.local/bin/claude" ]]; then
        CLAUDE_BIN="${HOME}/.local/bin/claude"
    elif [[ -x "/usr/local/bin/claude" ]]; then
        CLAUDE_BIN="/usr/local/bin/claude"
    else
        echo -e "${RED}âŒ éŒ¯èª¤: æœªå®‰è£ claude CLI${NC}"
        echo -e "${YELLOW}è«‹åŸ·è¡Œ: npm install -g @anthropic-ai/claude-cli${NC}"
        exit 1
    fi

    echo -e "${GREEN}   âœ… Claude CLI å·²å®‰è£ (${CLAUDE_BIN})${NC}"
    echo ""
}

check_data_files() {
    echo -e "${BLUE}ğŸ” æª¢æŸ¥è³‡æ–™æª”æ¡ˆ...${NC}"

    local missing_files=()

    if [[ ! -f "${GLOBAL_INDICES}" ]]; then
        missing_files+=("å…¨çƒæŒ‡æ•¸æª”æ¡ˆ: ${GLOBAL_INDICES}")
    fi

    if [[ ! -f "${PRICES}" ]]; then
        missing_files+=("æŒå€‰åƒ¹æ ¼æª”æ¡ˆ: ${PRICES}")
    fi

    if [[ ${#missing_files[@]} -gt 0 ]]; then
        echo -e "${YELLOW}âš ï¸  è­¦å‘Š: ä»¥ä¸‹è³‡æ–™æª”æ¡ˆä¸å­˜åœ¨:${NC}"
        for file in "${missing_files[@]}"; do
            echo -e "${YELLOW}  - ${file}${NC}"
        done
        echo ""
        echo -e "${YELLOW}è«‹å…ˆåŸ·è¡Œçˆ¬èŸ²è…³æœ¬: make fetch-all${NC}"
        exit 1
    fi

    echo -e "${GREEN}   âœ… è³‡æ–™æª”æ¡ˆå®Œæ•´${NC}"
    echo ""
}

collect_news_files() {
    # æŸ¥æ‰¾æ–°èæª”æ¡ˆ
    local news_files=($(find "${NEWS_DIR}" -name "*-${TODAY}.md" 2>/dev/null || true))
    local count=${#news_files[@]}

    # è¿”å›æª”æ¡ˆåˆ—è¡¨
    printf '%s\n' "${news_files[@]}"
}

###############################################################################
# å¸‚å ´åˆ†æå ±å‘Šç”Ÿæˆ
###############################################################################

generate_market_analysis_prompt() {
    echo -e "${BLUE}ğŸ“ ç”Ÿæˆå¸‚å ´åˆ†æ Prompt...${NC}"

    # è®€å–å…¨çƒæŒ‡æ•¸æ•¸æ“š
    local indices_data
    indices_data=$(<"${GLOBAL_INDICES}")

    # è®€å–æ–°èæ•¸æ“š
    local news_data=""
    local news_files
    # ç›¸å®¹ bash 3.x (macOS é»˜èªç‰ˆæœ¬)
    news_files=()
    while IFS= read -r line; do
        news_files+=("$line")
    done < <(collect_news_files)

    for news_file in "${news_files[@]}"; do
        if [[ -f "${news_file}" ]]; then
            local symbol
            symbol=$(basename "${news_file}" | sed "s/-${TODAY}.md//")
            local news_content
            news_content=$(<"${news_file}")
            news_data="${news_data}

### ${symbol} æ–°è
${news_content}"
        fi
    done

    local news_count=${#news_files[@]}

    # ç”Ÿæˆå¸‚å ´åˆ†æ Prompt
    cat > "${MARKET_PROMPT_FILE}" <<'EOF'
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å…¨çƒå¸‚å ´åˆ†æå¸«,æ“…é•·è§£è®€å¸‚å ´æ•¸æ“šå’Œæ–°è,æä¾›æ·±åº¦å¸‚å ´æ´å¯Ÿã€‚

## ğŸ“‹ åˆ†æä»»å‹™

è«‹æ ¹æ“šä»¥ä¸‹ä»Šæ—¥å¸‚å ´æ•¸æ“š,ç”Ÿæˆä¸€ä»½**å…¨çƒå¸‚å ´æƒ…å ±åˆ†æå ±å‘Š**ã€‚

### æ ¸å¿ƒè¦æ±‚:
1. **å¸‚å ´è¶¨å‹¢åˆ†æ**: è­˜åˆ¥å…¨çƒå¸‚å ´çš„ä¸»è¦è¶¨å‹¢å’Œé©…å‹•å› ç´ 
2. **æ–°èå½±éŸ¿è©•ä¼°**: æ·±åº¦è§£è®€é‡è¦æ–°èå°å¸‚å ´çš„æ½›åœ¨å½±éŸ¿
3. **ç”¢æ¥­è¼ªå‹•åˆ†æ**: åˆ†æè³‡é‡‘æµå‘å’Œç”¢æ¥­è¡¨ç¾
4. **é¢¨éšªèˆ‡æ©Ÿæœƒ**: è­˜åˆ¥ç•¶å‰å¸‚å ´é¢¨éšªå’ŒæŠ•è³‡æ©Ÿæœƒ
5. **å¾Œå¸‚å±•æœ›**: æä¾›æœªä¾†ä¸€é€±çš„å¸‚å ´å±•æœ›

### å ±å‘Šé¢¨æ ¼:
- å°ˆæ¥­ä½†æ˜“æ‡‚
- æ•¸æ“šé©…å‹•,æ´å¯Ÿç‚ºå…ˆ
- çµæ§‹æ¸…æ™°,é‡é»çªå‡º
- é¿å…æ¨¡ç³Šå»ºè­°,æä¾›å…·é«”æ–¹å‘

---

## ğŸ“Š ä»Šæ—¥å¸‚å ´æ•¸æ“š

### å…¨çƒå¸‚å ´æŒ‡æ•¸
```markdown
EOF

    cat >> "${MARKET_PROMPT_FILE}" <<EOF
${indices_data}
\`\`\`

### å¸‚å ´æ–°è (${news_count} å‰‡)
\`\`\`markdown
${news_data}
\`\`\`

---

## ğŸ“„ å ±å‘Šçµæ§‹

è«‹æŒ‰ç…§ä»¥ä¸‹çµæ§‹ç”Ÿæˆå ±å‘Š:

# ğŸ“ˆ å…¨çƒå¸‚å ´åˆ†æ - ${TODAY}

> **å ±å‘Šç”Ÿæˆæ™‚é–“**: $(date +"%Y-%m-%d %H:%M UTC")
> **åˆ†æå¼•æ“**: Market Intelligence System v2.0
> **å ±å‘Šé¡å‹**: å…¨çƒå¸‚å ´æƒ…å ±

---

## ğŸ“Š åŸ·è¡Œæ‘˜è¦

### å¸‚å ´æ¦‚æ³
[ç”¨ 2-3 æ®µæ–‡å­—ç¸½çµä»Šæ—¥å…¨çƒå¸‚å ´è¡¨ç¾:]
- ä¸»è¦å¸‚å ´è¶¨å‹¢ (ç¾è‚¡ã€äºè‚¡ã€æ­è‚¡)
- é—œéµé©…å‹•å› ç´ 
- å¸‚å ´æƒ…ç·’æŒ‡æ¨™ (VIX)
- é‡è¦äº‹ä»¶æˆ–æ•¸æ“š

### é—œéµæ•¸æ“š

| æŒ‡æ¨™ | æ•¸å€¼ | è®ŠåŒ– | ç‹€æ…‹ |
|------|------|------|------|
| S&P 500 | X,XXX.XX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |
| Nasdaq | XX,XXX.XX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |
| VIX | XX.XX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |
| å°è‚¡åŠ æ¬Š | XX,XXX.XX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |
| é»ƒé‡‘ | \\\$X,XXX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |

### å¸‚å ´æƒ…ç·’è©•ä¼°

| é¡åˆ¥ | è©•åˆ† (1-10) | èªªæ˜ |
|------|-------------|------|
| æ•´é«”å¸‚å ´æƒ…ç·’ | X | ç°¡çŸ­èªªæ˜ |
| ç§‘æŠ€è‚¡æƒ…ç·’ | X | ç°¡çŸ­èªªæ˜ |
| æ³¢å‹•æ€§é¢¨éšª | X | ç°¡çŸ­èªªæ˜ |

---

## ğŸŒ å…¨çƒå¸‚å ´æ·±åº¦åˆ†æ

### ç¾åœ‹å¸‚å ´ ğŸ‡ºğŸ‡¸

**ä¸»è¦æŒ‡æ•¸è¡¨ç¾**

| æŒ‡æ•¸ | æ”¶ç›¤åƒ¹ | æ¼²è·Œå¹… | æŠ€è¡“ç‹€æ…‹ |
|------|--------|--------|----------|
| S&P 500 | X,XXX.XX | +X.XX% | æè¿° |
| Nasdaq | XX,XXX.XX | +X.XX% | æè¿° |
| Dow Jones | XX,XXX.XX | +X.XX% | æè¿° |

**å¸‚å ´åˆ†æ**:
[æ·±å…¥åˆ†æç¾åœ‹å¸‚å ´:]
- ä¸»è¦é©…å‹•å› ç´ 
- ç”¢æ¥­è¼ªå‹•æƒ…æ³
- æŠ€è¡“é¢é—œéµæ°´å¹³
- å¾Œå¸‚å±•æœ›

### äºæ´²å¸‚å ´ ğŸŒ

**ä¸»è¦å¸‚å ´è¡¨ç¾**

| å¸‚å ´ | æŒ‡æ•¸ | æ”¶ç›¤åƒ¹ | æ¼²è·Œå¹… |
|------|------|--------|--------|
| ğŸ‡¹ğŸ‡¼ å°ç£ | åŠ æ¬ŠæŒ‡æ•¸ | XX,XXX.XX | +X.XX% |
| ğŸ‡¯ğŸ‡µ æ—¥æœ¬ | æ—¥ç¶“225 | XX,XXX.XX | +X.XX% |
| ğŸ‡°ğŸ‡· éŸ“åœ‹ | KOSPI | X,XXX.XX | +X.XX% |

**å¸‚å ´åˆ†æ**:
[åˆ†æäºæ´²å¸‚å ´è¶¨å‹¢]

### æ­æ´²å¸‚å ´ ğŸ‡ªğŸ‡º

**å¸‚å ´åˆ†æ**:
[ç°¡è¦åˆ†ææ­æ´²å¸‚å ´]

---

## ğŸ“° é‡è¦æ–°èè§£è®€

[æŒ‰ä¸»é¡Œæˆ–ç”¢æ¥­åˆ†é¡,æ·±å…¥è§£è®€å½±éŸ¿å¸‚å ´çš„é‡è¦æ–°è:]

### ç§‘æŠ€ç”¢æ¥­

#### æ–°èæ¨™é¡Œ
[æ·±åº¦åˆ†ææ–°èå…§å®¹ã€å¸‚å ´å½±éŸ¿ã€æŠ•è³‡å•Ÿç¤º]

### å…¶ä»–ç”¢æ¥­

#### æ–°èæ¨™é¡Œ
[åŒä¸Š]

---

## ğŸ­ ç”¢æ¥­è¼ªå‹•åˆ†æ

### å¼·å‹¢ç”¢æ¥­

| ç”¢æ¥­ | è¡¨ç¾ | é©…å‹•å› ç´  |
|------|------|----------|
| ç”¢æ¥­1 | +X.XX% | ç°¡è¿° |
| ç”¢æ¥­2 | +X.XX% | ç°¡è¿° |

### å¼±å‹¢ç”¢æ¥­

| ç”¢æ¥­ | è¡¨ç¾ | åŸå›  |
|------|------|------|
| ç”¢æ¥­1 | -X.XX% | ç°¡è¿° |

**åˆ†æ**: [æ·±å…¥åˆ†æç”¢æ¥­è¼ªå‹•èƒŒå¾Œçš„é‚è¼¯]

---

## âš ï¸ é¢¨éšªèˆ‡æ©Ÿæœƒ

### å¸‚å ´é¢¨éšª

1. **é¢¨éšª1**: è©³ç´°èªªæ˜
2. **é¢¨éšª2**: è©³ç´°èªªæ˜
3. **é¢¨éšª3**: è©³ç´°èªªæ˜

### æŠ•è³‡æ©Ÿæœƒ

1. **æ©Ÿæœƒ1**: è©³ç´°èªªæ˜
2. **æ©Ÿæœƒ2**: è©³ç´°èªªæ˜

### VIX ææ…ŒæŒ‡æ•¸åˆ†æ

- **ç•¶å‰å€¼**: XX.XX
- **è®ŠåŒ–**: Â±X.XX%
- **è§£è®€**: [åˆ†æå¸‚å ´æƒ…ç·’å’Œæ³¢å‹•æ€§é æœŸ]

---

## ğŸ”® å¾Œå¸‚å±•æœ›

### æœªä¾†ä¸€é€±é—œéµäº‹ä»¶

**ç¶“æ¿Ÿæ•¸æ“š**:
- æ—¥æœŸ: æ•¸æ“šåç¨± - é æœŸå½±éŸ¿
- æ—¥æœŸ: æ•¸æ“šåç¨± - é æœŸå½±éŸ¿

**ä¼æ¥­è²¡å ±**:
- æ—¥æœŸ: å…¬å¸åç¨± - é—œæ³¨é‡é»

**å…¶ä»–é‡è¦äº‹ä»¶**:
- äº‹ä»¶æè¿°

### æƒ…å¢ƒåˆ†æ

#### æ¨‚è§€æƒ…å¢ƒ (æ©Ÿç‡: XX%)
[æ¢ä»¶ã€é æœŸå½±éŸ¿ã€å¸‚å ´åæ‡‰]

#### åŸºæº–æƒ…å¢ƒ (æ©Ÿç‡: XX%)
[æ¢ä»¶ã€é æœŸå½±éŸ¿ã€å¸‚å ´åæ‡‰]

#### æ‚²è§€æƒ…å¢ƒ (æ©Ÿç‡: XX%)
[æ¢ä»¶ã€é æœŸå½±éŸ¿ã€å¸‚å ´åæ‡‰]

---

## ğŸ’¡ æŠ•è³‡ç­–ç•¥å»ºè­°

### çŸ­æœŸè§€é» (1-2é€±)

**å¸‚å ´çœ‹æ³•**: [ç¸½çµ]

**ç­–ç•¥å»ºè­°**:
1. å»ºè­°1
2. å»ºè­°2

### ä¸­æœŸè§€é» (1-3å€‹æœˆ)

**å¸‚å ´çœ‹æ³•**: [ç¸½çµ]

**ç­–ç•¥å»ºè­°**:
1. å»ºè­°1
2. å»ºè­°2

---

## âš ï¸ å…è²¬è²æ˜

æœ¬å ±å‘Šåƒ…ä¾›åƒè€ƒ,ä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚æŠ•è³‡æœ‰é¢¨éšª,è«‹æ ¹æ“šè‡ªèº«æƒ…æ³åšå‡ºç¨ç«‹æ±ºç­–ã€‚

---

**å ±å‘Šè£½ä½œ**: Market Intelligence System
**åˆ†æå¼•æ“**: Claude (Sonnet 4.5)
**æ•¸æ“šä¾†æº**: Yahoo Finance
**å ±å‘Šç‰ˆæœ¬**: v2.0

---

è«‹ç›´æ¥é–‹å§‹ç”Ÿæˆå®Œæ•´çš„å¸‚å ´åˆ†æå ±å‘Š,å¾æ¨™é¡Œé–‹å§‹,ä¸è¦æœ‰ä»»ä½•å‰ç½®èªªæ˜æˆ–è©¢å•ã€‚
EOF

    echo -e "${GREEN}   âœ… å¸‚å ´åˆ†æ Prompt å·²ç”Ÿæˆ${NC}"
    echo ""
}

run_market_analysis() {
    echo -e "${BLUE}ğŸ§  èª¿ç”¨ Claude é€²è¡Œå¸‚å ´åˆ†æ...${NC}"
    echo -e "${YELLOW}   é€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜,è«‹ç¨å€™...${NC}"
    echo ""

    mkdir -p "${REPORTS_DIR}"

    if cat "${MARKET_PROMPT_FILE}" | "${CLAUDE_BIN}" > "${MARKET_ANALYSIS_OUTPUT}" 2>&1; then
        echo -e "${GREEN}   âœ… å¸‚å ´åˆ†æå®Œæˆ!${NC}"
        echo ""
    else
        echo -e "${RED}   âŒ å¸‚å ´åˆ†æå¤±æ•—${NC}"
        exit 1
    fi
}

###############################################################################
# æŒå€‰åˆ†æå ±å‘Šç”Ÿæˆ
###############################################################################

generate_holdings_analysis_prompt() {
    echo -e "${BLUE}ğŸ“ ç”ŸæˆæŒå€‰åˆ†æ Prompt...${NC}"

    # è®€å–æŒå€‰åƒ¹æ ¼æ•¸æ“š
    local prices_data
    prices_data=$(<"${PRICES}")

    # è®€å–æŒå€‰é…ç½®æ•¸æ“š
    local holdings_config=""
    if [[ -f "${HOLDINGS_CONFIG}" ]]; then
        holdings_config=$(<"${HOLDINGS_CONFIG}")
    fi

    # è®€å–æŠ•è³‡çµ„åˆå®Œæ•´è³‡è¨Š
    local portfolio_data=""
    if [[ -f "${PORTFOLIO_HOLDINGS}" ]]; then
        portfolio_data=$(<"${PORTFOLIO_HOLDINGS}")
    fi

    # ç”ŸæˆæŒå€‰åˆ†æ Prompt
    cat > "${HOLDINGS_PROMPT_FILE}" <<'EOF'
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æŠ•è³‡çµ„åˆåˆ†æå¸«,æ“…é•·è©•ä¼°æŒå€‰è¡¨ç¾ã€è³‡ç”¢é…ç½®å’Œé¢¨éšªç®¡ç†ã€‚

## ğŸ“‹ åˆ†æä»»å‹™

è«‹æ ¹æ“šä»¥ä¸‹æŠ•è³‡çµ„åˆæ•¸æ“š,ç”Ÿæˆä¸€ä»½**æŒå€‰åˆ†æå ±å‘Š**ã€‚

### æ ¸å¿ƒè¦æ±‚:
1. **è³‡ç”¢é…ç½®åˆ†æ**: è©•ä¼°ç¾é‡‘/è‚¡ç¥¨æ¯”ä¾‹æ˜¯å¦åˆç†
2. **æŒå€‰è¡¨ç¾è©•ä¼°**: åˆ†ææ¯æª”è‚¡ç¥¨çš„è¡¨ç¾ï¼ˆè€ƒæ…®æˆæœ¬ã€ç•¶å‰åƒ¹ã€å€‰ä½ï¼‰
3. **é¸æ“‡æ¬Šé¢¨éšªç®¡ç†**: è©•ä¼°é¸æ“‡æ¬Šéƒ¨ä½é¢¨éšª,æä¾›åˆ°æœŸè™•ç†å»ºè­°
4. **å€‰ä½èª¿æ•´å»ºè­°**: åŸºæ–¼å¸‚å ´ç’°å¢ƒå’Œå€‹è‚¡è¡¨ç¾æä¾›åŠ æ¸›ç¢¼å»ºè­°
5. **é¢¨éšªæ§åˆ¶**: è­˜åˆ¥å€‰ä½éé‡ã€æå¤±éå¤§ç­‰é¢¨éšªé»

### å ±å‘Šé¢¨æ ¼:
- å…·é«”ã€å¯æ“ä½œ
- åŸºæ–¼æ•¸æ“šå’Œæˆæœ¬åƒ¹
- è€ƒæ…®é¸æ“‡æ¬Šç´„æŸ
- æä¾›æ˜ç¢ºçš„è²·è³£å»ºè­°

---

## ğŸ“Š æŠ•è³‡çµ„åˆæ•¸æ“š

### æŠ•è³‡çµ„åˆå®Œæ•´è³‡è¨Š
```markdown
EOF

    cat >> "${HOLDINGS_PROMPT_FILE}" <<EOF
${portfolio_data}
\`\`\`

### æŒå€‰é…ç½®è©³æƒ…
\`\`\`yaml
${holdings_config}
\`\`\`

### ä»Šæ—¥æŒå€‰åƒ¹æ ¼
\`\`\`markdown
${prices_data}
\`\`\`

---

## ğŸ“„ å ±å‘Šçµæ§‹

è«‹æŒ‰ç…§ä»¥ä¸‹çµæ§‹ç”Ÿæˆå ±å‘Š:

# ğŸ’¼ æŠ•è³‡çµ„åˆåˆ†æ - ${TODAY}

> **å ±å‘Šç”Ÿæˆæ™‚é–“**: $(date +"%Y-%m-%d %H:%M UTC")
> **åˆ†æå¼•æ“**: Market Intelligence System v2.0
> **å ±å‘Šé¡å‹**: æŒå€‰åˆ†æ

---

## ğŸ“Š åŸ·è¡Œæ‘˜è¦

### çµ„åˆæ¦‚æ³

| é …ç›® | æ•¸å€¼ | ç‹€æ…‹è©•ä¼° |
|------|------|----------|
| ç¸½è³‡ç”¢æ·¨å€¼ | \\\$XXX,XXX.XX | - |
| è‚¡ç¥¨å¸‚å€¼ | \\\$XXX,XXX.XX (XX.X%) | ğŸŸ¢/ğŸŸ¡/ğŸ”´ è©•ä¼° |
| ç¾é‡‘é¤˜é¡ | \\\$XX,XXX.XX (XX.X%) | ğŸŸ¢/ğŸŸ¡/ğŸ”´ è©•ä¼° |
| æœªå¯¦ç¾æç›Š | Â±\\\$XX,XXX (Â±X.X%) | ğŸŸ¢/ğŸ”´ è©•ä¼° |
| è³¼è²·åŠ› | \\\$XXX,XXX.XX | - |

### ä»Šæ—¥é—œéµè®ŠåŒ–

- **æœ€å¤§æ¼²å¹…**: TICKER +X.XX% (èªªæ˜)
- **æœ€å¤§è·Œå¹…**: TICKER -X.XX% (èªªæ˜)
- **çµ„åˆè®ŠåŒ–**: Â±X.XX% (vs å‰ä¸€äº¤æ˜“æ—¥)
- **é—œéµé¢¨éšª**: [åˆ—å‡ºéœ€è¦æ³¨æ„çš„é¢¨éšª]

---

## ğŸ’° è³‡ç”¢é…ç½®åˆ†æ

### ç•¶å‰é…ç½®

| è³‡ç”¢é¡åˆ¥ | é‡‘é¡ | ä½”æ¯” | å»ºè­°ç¯„åœ | è©•ä¼° |
|----------|------|------|----------|------|
| ç¾é‡‘ | \\\$XX,XXX.XX | XX.X% | 10-30% | ğŸŸ¢/ğŸŸ¡/ğŸ”´ |
| è‚¡ç¥¨ | \\\$XXX,XXX.XX | XX.X% | 70-90% | ğŸŸ¢/ğŸŸ¡/ğŸ”´ |

**é…ç½®è©•ä¼°**:
[è©³ç´°è©•ä¼°ç¾é‡‘æ¯”ä¾‹æ˜¯å¦åˆç†,è€ƒæ…®:]
- ç•¶å‰å¸‚å ´ç’°å¢ƒ
- é¸æ“‡æ¬Šåˆ°æœŸé¢¨éšª
- æŒå€‰è¡¨ç¾
- åŠ ç¢¼æ©Ÿæœƒ

**èª¿æ•´å»ºè­°**:
- æ˜¯å¦éœ€è¦å¢åŠ /æ¸›å°‘ç¾é‡‘
- ç†ç”±å’Œå…·é«”æ“ä½œå»ºè­°

---

## ğŸ¯ é¸æ“‡æ¬Šéƒ¨ä½åˆ†æ

### 12/05 åˆ°æœŸé¸æ“‡æ¬Šï¼ˆ3å¤©å¾Œï¼‰âš ï¸

| æ¨™çš„ | é¡å‹ | æ•¸é‡ | è¡Œæ¬Šåƒ¹ | ç•¶å‰åƒ¹ | ç‹€æ…‹ | é¢¨éšªè©•ä¼° |
|------|------|------|--------|--------|------|----------|
| TICKER | Type | -X | \\\$XX.XX | \\\$XX.XX | åƒ¹å…§/åƒ¹å¤– | é«˜/ä¸­/ä½ |

**è™•ç†å»ºè­°**:
1. **TICKER**: [å…·é«”å»ºè­° - å›è£œã€è®“åŸ·è¡Œã€èª¿æ•´ç­‰]
2. **TICKER**: [å…·é«”å»ºè­°]

### 12/19 åˆ°æœŸé¸æ“‡æ¬Šï¼ˆ17å¤©å¾Œï¼‰

| æ¨™çš„ | é¡å‹ | æ•¸é‡ | è¡Œæ¬Šåƒ¹ | ç•¶å‰åƒ¹ | ç‹€æ…‹ | é¢¨éšªè©•ä¼° |
|------|------|------|--------|--------|------|----------|
| TICKER | Type | -X | \\\$XX.XX | \\\$XX.XX | åƒ¹å…§/åƒ¹å¤– | é«˜/ä¸­/ä½ |

**è™•ç†å»ºè­°**:
[è©•ä¼°æ˜¯å¦éœ€è¦æå‰è¡Œå‹•]

### é¸æ“‡æ¬Šç­–ç•¥è©•ä¼°

**ç•¶å‰ç­–ç•¥**:
- Covered Call ç­–ç•¥: [è©•ä¼°æ•ˆæœ]
- Cash Secured Put ç­–ç•¥: [è©•ä¼°æ•ˆæœ]

**é¢¨éšªèˆ‡æ©Ÿæœƒ**:
- æ½›åœ¨è¢«åŸ·è¡Œæ¨™çš„: [åˆ—å‡ºä¸¦è©•ä¼°å½±éŸ¿]
- é¡å¤–æ”¶ç›Šæ©Ÿæœƒ: [æ˜¯å¦æœ‰æ–°çš„é¸æ“‡æ¬Šæ©Ÿæœƒ]

---

## ğŸ“ˆ æŒå€‰è¡¨ç¾åˆ†æ

### ä»Šæ—¥æ¼²è·Œåˆ†ä½ˆ

| åˆ†é¡ | æ•¸é‡ | å¹³å‡æ¼²è·Œ | å°çµ„åˆå½±éŸ¿ |
|------|------|----------|------------|
| å¼·å‹¢ä¸Šæ¼² (>+2%) | X æª” | +X.XX% | +\\\$X,XXX |
| ç©©å¥ä¸Šæ¼² (+0%~+2%) | X æª” | +X.XX% | +\\\$X,XXX |
| è¼•å¾®ä¸‹è·Œ (0%~-2%) | X æª” | -X.XX% | -\\\$X,XXX |
| é‡å¤§è™§æ (<-2%) | X æª” | -X.XX% | -\\\$X,XXX |

### é‡é»æŒè‚¡æ·±åº¦åˆ†æ

[é‡å°ä»¥ä¸‹æƒ…æ³çš„è‚¡ç¥¨é€²è¡Œåˆ†æ:]
- ä»Šæ—¥æ¼²è·Œå¹… > 2%
- å€‰ä½ > 5%
- æœ‰é¸æ“‡æ¬Šéƒ¨ä½
- è™§æ/ç²åˆ©è¶…é 10%

#### ğŸ“Š TICKER - å…¬å¸åç¨±

**åŸºæœ¬è³‡è¨Š**:
- æŒè‚¡: XXX è‚¡
- æˆæœ¬åƒ¹: \\\$XX.XX
- ç•¶å‰åƒ¹: \\\$XX.XX
- å¸‚å€¼: \\\$XX,XXX
- å€‰ä½ä½”æ¯”: X.X%
- æç›Š: Â±\\\$X,XXX (Â±XX.X%)

**ä»Šæ—¥è¡¨ç¾**:
- æ”¶ç›¤åƒ¹: \\\$XX.XX
- è®ŠåŒ–: +X.XX% (+\\\$X.XX)
- å€é–“: \\\$XX.XX - \\\$XX.XX

**é¸æ“‡æ¬Šç´„æŸ**:
[å¦‚æœ‰é¸æ“‡æ¬Š,åˆ—å‡ºè©³æƒ…å’Œå½±éŸ¿]

**æ“ä½œå»ºè­°**:
- **å»ºè­°**: æŒæœ‰ / åŠ ç¢¼ / æ¸›ç¢¼ / è§€æœ›
- **ç†ç”±**: [åŸºæ–¼æˆæœ¬ã€å€‰ä½ã€è¡¨ç¾ã€é¸æ“‡æ¬Š]
- **å…·é«”æ“ä½œ**: [å¦‚"åœ¨ \\\$XX.XX ä»¥ä¸‹åŠ ç¢¼ XX è‚¡"]
- **é¢¨éšªæç¤º**: [é—œéµé¢¨éšªé»]

[é‡è¤‡ä»¥ä¸Šæ ¼å¼åˆ†æå…¶ä»–é‡é»æŒè‚¡]

---

## âš–ï¸ å€‰ä½çµæ§‹åˆ†æ

### å€‰ä½åˆ†ä½ˆ

| å€‰ä½ç´šåˆ¥ | è‚¡ç¥¨æ•¸é‡ | ä½”æ¯” | è©•ä¼° |
|----------|----------|------|------|
| æ ¸å¿ƒæŒå€‰ (>10%) | X æª” | XX.X% | æ˜¯å¦éåº¦é›†ä¸­ |
| ä¸»è¦æŒå€‰ (5-10%) | X æª” | XX.X% | è©•ä¼° |
| ä¸€èˆ¬æŒå€‰ (2-5%) | X æª” | XX.X% | è©•ä¼° |
| å°å€‰ä½ (<2%) | X æª” | XX.X% | è©•ä¼° |

### ç”¢æ¥­é›†ä¸­åº¦

| ç”¢æ¥­ | è‚¡ç¥¨ | ä½”æ¯” | è©•ä¼° |
|------|------|------|------|
| ç§‘æŠ€ | TICKER, TICKER | XX.X% | ğŸŸ¢/ğŸŸ¡/ğŸ”´ |
| å·¥æ¥­ | TICKER | XX.X% | ğŸŸ¢/ğŸŸ¡/ğŸ”´ |

**é¢¨éšªè©•ä¼°**:
[è©•ä¼°æ˜¯å¦éåº¦é›†ä¸­åœ¨æŸå€‹ç”¢æ¥­æˆ–è‚¡ç¥¨]

---

## ğŸ¯ å€‰ä½èª¿æ•´å»ºè­°

### é«˜å„ªå…ˆç´šæ“ä½œï¼ˆæœ¬é€±å…§ï¼‰

#### åŠ ç¢¼å»ºè­°

1. **TICKER** (å»ºè­°åŠ ç¢¼è‡³ X.X%)
   - ç•¶å‰å€‰ä½: X.X%
   - ç†ç”±: [åŸºæ–¼è¡¨ç¾ã€ä¼°å€¼ã€å¸‚å ´ç’°å¢ƒ]
   - å»ºè­°åƒ¹ä½: \\\$XX.XX ä»¥ä¸‹
   - å»ºè­°è‚¡æ•¸: XX è‚¡
   - è³‡é‡‘éœ€æ±‚: \\\$X,XXX
   - é¢¨éšª: [é—œéµé¢¨éšª]

#### æ¸›ç¢¼å»ºè­°

1. **TICKER** (å»ºè­°æ¸›è‡³ X.X%)
   - ç•¶å‰å€‰ä½: X.X%
   - ç†ç”±: [å€‰ä½éé‡ã€è¡¨ç¾ä¸ä½³ç­‰]
   - å»ºè­°åƒ¹ä½: \\\$XX.XX ä»¥ä¸Š
   - å»ºè­°è‚¡æ•¸: XX è‚¡
   - é æœŸå›æ”¶: \\\$X,XXX
   - å½±éŸ¿: [é¸æ“‡æ¬Šã€ç¨…å‹™ç­‰]

#### è§€æœ›æŒæœ‰

[åˆ—å‡ºå»ºè­°ç¹¼çºŒæŒæœ‰çš„è‚¡ç¥¨åŠç†ç”±]

### ä¸­æœŸæ“ä½œï¼ˆ1-4é€±ï¼‰

[åˆ—å‡ºä¸­æœŸçš„å€‰ä½èª¿æ•´è¨ˆåŠƒ]

---

## âš ï¸ é¢¨éšªæç¤º

### é«˜é¢¨éšªé»

1. **é¸æ“‡æ¬Šåˆ°æœŸé¢¨éšª**: [12/05 å³å°‡åˆ°æœŸçš„è©³ç´°åˆ†æ]
2. **å€‰ä½é›†ä¸­é¢¨éšª**: [æ˜¯å¦éåº¦é›†ä¸­]
3. **è™§ææ”¾å¤§é¢¨éšª**: [è™§æè¼ƒå¤§çš„æŒè‚¡]

### æ‡‰å°æªæ–½

1. [é‡å°æ¯å€‹é¢¨éšªé»çš„å…·é«”æ‡‰å°æªæ–½]

---

## âœ… è¡Œå‹•æ¸…å–®

### ç«‹å³åŸ·è¡Œï¼ˆä»Šæ—¥/æ˜æ—¥ï¼‰

- [ ] **æ“ä½œ1**: å…·é«”æè¿°ï¼ˆå¦‚: ç›£æ§ U é¸æ“‡æ¬Š,æº–å‚™å›è£œï¼‰
- [ ] **æ“ä½œ2**: å…·é«”æè¿°

### æœ¬é€±åŸ·è¡Œ

- [ ] **æ“ä½œ1**: å…·é«”æè¿°
- [ ] **æ“ä½œ2**: å…·é«”æè¿°

### æŒçºŒç›£æ§

- [ ] **ç›£æ§1**: å…·é«”æè¿°
- [ ] **ç›£æ§2**: å…·é«”æè¿°

---

## ğŸ“Š ç¸¾æ•ˆè¿½è¹¤

### æœ¬æœˆç¸¾æ•ˆï¼ˆæˆªè‡³ä»Šæ—¥ï¼‰

| æŒ‡æ¨™ | æ•¸å€¼ |
|------|------|
| æœˆåº¦å ±é…¬ç‡ | Â±X.XX% |
| vs S&P 500 | Â±X.XX% |
| æœ€ä½³æŒè‚¡ | TICKER (+XX.X%) |
| æœ€å·®æŒè‚¡ | TICKER (-XX.X%) |

---

## âš ï¸ å…è²¬è²æ˜

æœ¬å ±å‘Šåƒ…ä¾›åƒè€ƒ,ä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚æŠ•è³‡æœ‰é¢¨éšª,è«‹æ ¹æ“šè‡ªèº«æƒ…æ³åšå‡ºç¨ç«‹æ±ºç­–ã€‚

---

**å ±å‘Šè£½ä½œ**: Market Intelligence System
**åˆ†æå¼•æ“**: Claude (Sonnet 4.5)
**æ•¸æ“šä¾†æº**: Portfolio Management System
**å ±å‘Šç‰ˆæœ¬**: v2.0

---

è«‹ç›´æ¥é–‹å§‹ç”Ÿæˆå®Œæ•´çš„æŒå€‰åˆ†æå ±å‘Š,å¾æ¨™é¡Œé–‹å§‹,ä¸è¦æœ‰ä»»ä½•å‰ç½®èªªæ˜æˆ–è©¢å•ã€‚
EOF

    echo -e "${GREEN}   âœ… æŒå€‰åˆ†æ Prompt å·²ç”Ÿæˆ${NC}"
    echo ""
}

run_holdings_analysis() {
    echo -e "${BLUE}ğŸ§  èª¿ç”¨ Claude é€²è¡ŒæŒå€‰åˆ†æ...${NC}"
    echo -e "${YELLOW}   é€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜,è«‹ç¨å€™...${NC}"
    echo ""

    mkdir -p "${REPORTS_DIR}"

    if cat "${HOLDINGS_PROMPT_FILE}" | "${CLAUDE_BIN}" > "${HOLDINGS_ANALYSIS_OUTPUT}" 2>&1; then
        echo -e "${GREEN}   âœ… æŒå€‰åˆ†æå®Œæˆ!${NC}"
        echo ""
    else
        echo -e "${RED}   âŒ æŒå€‰åˆ†æå¤±æ•—${NC}"
        exit 1
    fi
}

###############################################################################
# çµæœå±•ç¤º
###############################################################################

show_results() {
    echo -e "${BLUE}============================================================${NC}"
    echo -e "${GREEN}ğŸ“„ åˆ†æå ±å‘Šå·²ç”Ÿæˆ!${NC}"
    echo -e "${BLUE}============================================================${NC}"
    echo ""

    echo -e "${GREEN}ğŸ“ˆ å¸‚å ´åˆ†æå ±å‘Š:${NC}"
    echo -e "${GREEN}   ${MARKET_ANALYSIS_OUTPUT}${NC}"
    echo ""

    echo -e "${GREEN}ğŸ’¼ æŒå€‰åˆ†æå ±å‘Š:${NC}"
    echo -e "${GREEN}   ${HOLDINGS_ANALYSIS_OUTPUT}${NC}"
    echo ""

    # é¡¯ç¤ºå¸‚å ´åˆ†æé è¦½
    echo -e "${BLUE}ğŸ“‹ å¸‚å ´åˆ†æé è¦½ (å‰ 20 è¡Œ):${NC}"
    echo -e "${BLUE}------------------------------------------------------------${NC}"
    head -n 20 "${MARKET_ANALYSIS_OUTPUT}"
    echo -e "${BLUE}------------------------------------------------------------${NC}"
    echo ""

    # é¡¯ç¤ºæŒå€‰åˆ†æé è¦½
    echo -e "${BLUE}ğŸ“‹ æŒå€‰åˆ†æé è¦½ (å‰ 20 è¡Œ):${NC}"
    echo -e "${BLUE}------------------------------------------------------------${NC}"
    head -n 20 "${HOLDINGS_ANALYSIS_OUTPUT}"
    echo -e "${BLUE}------------------------------------------------------------${NC}"
    echo ""

    echo -e "${GREEN}ğŸ’¡ æŸ¥çœ‹å®Œæ•´å ±å‘Š:${NC}"
    echo -e "${GREEN}   cat ${MARKET_ANALYSIS_OUTPUT}${NC}"
    echo -e "${GREEN}   cat ${HOLDINGS_ANALYSIS_OUTPUT}${NC}"
    echo ""
}

cleanup() {
    # æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
    rm -f "${MARKET_PROMPT_FILE}" "${HOLDINGS_PROMPT_FILE}"
}

###############################################################################
# ä¸»ç¨‹å¼
###############################################################################

update_github_pages() {
    echo -e "${BLUE}ğŸ“ æ›´æ–° GitHub Pages...${NC}"
    echo ""

    # æª¢æŸ¥æ›´æ–°è…³æœ¬æ˜¯å¦å­˜åœ¨
    local update_script="${PROJECT_ROOT}/src/scripts/deployment/update_github_pages.sh"
    if [[ -x "${update_script}" ]]; then
        "${update_script}"
        echo -e "${GREEN}   âœ… GitHub Pages æ›´æ–°å®Œæˆ${NC}"
        echo ""
    else
        echo -e "${YELLOW}   âš ï¸  æœªæ‰¾åˆ°æ›´æ–°è…³æœ¬,è·³é GitHub Pages æ›´æ–°${NC}"
        echo ""
    fi
}

main() {
    print_header
    check_dependencies
    check_data_files

    echo -e "${BLUE}ğŸ“Š ç”Ÿæˆå¸‚å ´åˆ†æå ±å‘Š...${NC}"
    echo ""
    generate_market_analysis_prompt
    run_market_analysis

    echo -e "${BLUE}ğŸ’¼ ç”ŸæˆæŒå€‰åˆ†æå ±å‘Š...${NC}"
    echo ""
    generate_holdings_analysis_prompt
    run_holdings_analysis

    show_results

    # è‡ªå‹•æ›´æ–° GitHub Pages HTML
    update_github_pages

    cleanup

    echo -e "${GREEN}âœ… æ¯æ—¥é›™å ±å‘Šåˆ†æå®Œæˆ!${NC}"
    echo ""
}

# åŸ·è¡Œä¸»ç¨‹å¼
main "$@"
