#!/usr/bin/env bash
###############################################################################
# Market Intelligence System - Daily Analysis (Claude CLI Version)
#
# ä½¿ç”¨ Claude CLI é€²è¡Œæ¯æ—¥å¸‚å ´åˆ†æ
# åƒè€ƒ FAS çš„å¯¦ä½œæ–¹å¼,ä½¿ç”¨ç´” Bash + Claude CLI
#
# ä¾è³´:
#   - claude CLI (npm install -g @anthropic-ai/claude-cli)
#   - å·²ç™»å…¥ Claude CLI (claude login)
#
# ä½¿ç”¨æ–¹å¼:
#   ./analyzers/run_daily_analysis_claude_cli.sh
#   æˆ–
#   make analyze-daily
###############################################################################

set -e  # é‡åˆ°éŒ¯èª¤ç«‹å³é€€å‡º

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥æœŸ
TODAY=$(date +"%Y-%m-%d")
YEAR=$(date +"%Y")

# è·¯å¾‘
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
OUTPUT_DIR="${PROJECT_ROOT}/output/market-data/${YEAR}"
DAILY_DIR="${OUTPUT_DIR}/Daily"
NEWS_DIR="${OUTPUT_DIR}/News"
ANALYSIS_DIR="${PROJECT_ROOT}/analysis"

# æª”æ¡ˆè·¯å¾‘
GLOBAL_INDICES="${DAILY_DIR}/global-indices-${TODAY}.md"
PRICES="${DAILY_DIR}/holdings-prices-${TODAY}.md"
ANALYSIS_OUTPUT="${ANALYSIS_DIR}/market-analysis-${TODAY}.md"
PROMPT_FILE="/tmp/market-analysis-prompt-${TODAY}.txt"

###############################################################################
# å‡½æ•¸å®šç¾©
###############################################################################

print_header() {
    echo -e "${BLUE}============================================================${NC}"
    echo -e "${BLUE}ğŸ“Š Market Intelligence System - æ¯æ—¥å¸‚å ´åˆ†æ (Claude CLI)${NC}"
    echo -e "${BLUE}============================================================${NC}"
    echo ""
    echo -e "${GREEN}ğŸ“… åˆ†ææ—¥æœŸ: ${TODAY}${NC}"
    echo ""
}

check_dependencies() {
    echo -e "${BLUE}ğŸ” æª¢æŸ¥ä¾è³´...${NC}"

    # æª¢æŸ¥ claude CLI (æ”¯æ´å¤šå€‹å¯èƒ½çš„å®‰è£ä½ç½®)
    CLAUDE_BIN=""
    if command -v claude &> /dev/null; then
        CLAUDE_BIN="claude"
    elif [[ -x "${HOME}/.local/bin/claude" ]]; then
        CLAUDE_BIN="${HOME}/.local/bin/claude"
    elif [[ -x "/usr/local/bin/claude" ]]; then
        CLAUDE_BIN="/usr/local/bin/claude"
    else
        echo -e "${RED}âŒ éŒ¯èª¤: æœªå®‰è£ claude CLI${NC}"
        echo -e "${YELLOW}è«‹åŸ·è¡Œ: npm install -g @anthropic-ai/claude-cli${NC}"
        exit 1
    fi

    echo -e "${GREEN}   âœ… Claude CLI å·²å®‰è£ (${CLAUDE_BIN})${NC}"
    echo ""
}

check_data_files() {
    echo -e "${BLUE}ğŸ” æª¢æŸ¥è³‡æ–™æª”æ¡ˆ...${NC}"

    local missing_files=()

    if [[ ! -f "${GLOBAL_INDICES}" ]]; then
        missing_files+=("å…¨çƒæŒ‡æ•¸æª”æ¡ˆ: ${GLOBAL_INDICES}")
    fi

    if [[ ! -f "${PRICES}" ]]; then
        missing_files+=("æŒå€‰åƒ¹æ ¼æª”æ¡ˆ: ${PRICES}")
    fi

    if [[ ${#missing_files[@]} -gt 0 ]]; then
        echo -e "${YELLOW}âš ï¸  è­¦å‘Š: ä»¥ä¸‹è³‡æ–™æª”æ¡ˆä¸å­˜åœ¨:${NC}"
        for file in "${missing_files[@]}"; do
            echo -e "${YELLOW}  - ${file}${NC}"
        done
        echo ""
        echo -e "${YELLOW}è«‹å…ˆåŸ·è¡Œçˆ¬èŸ²è…³æœ¬:${NC}"
        echo -e "${YELLOW}  make fetch-all${NC}"
        exit 1
    fi

    echo -e "${GREEN}   âœ… è³‡æ–™æª”æ¡ˆå®Œæ•´${NC}"
    echo ""
}

collect_news_files() {
    echo -e "${BLUE}ğŸ“° æ”¶é›†ç•¶æ—¥æ–°èæª”æ¡ˆ...${NC}"

    # æŸ¥æ‰¾æ–°èæª”æ¡ˆ
    local news_files=($(find "${NEWS_DIR}" -name "*-${TODAY}.md" 2>/dev/null || true))
    local count=${#news_files[@]}

    echo -e "${GREEN}   æ‰¾åˆ° ${count} å€‹æ–°èæª”æ¡ˆ${NC}"
    echo ""

    # è¿”å›æª”æ¡ˆåˆ—è¡¨ (é€šé stdout)
    printf '%s\n' "${news_files[@]}"
}

generate_analysis_prompt() {
    echo -e "${BLUE}ğŸ“ ç”Ÿæˆåˆ†æ Prompt...${NC}"

    # è®€å–å…¨çƒæŒ‡æ•¸æ•¸æ“š
    local indices_data
    indices_data=$(<"${GLOBAL_INDICES}")

    # è®€å–æŒå€‰åƒ¹æ ¼æ•¸æ“š
    local prices_data
    prices_data=$(<"${PRICES}")

    # è®€å–æ–°èæ•¸æ“š
    local news_data=""
    local news_files
    mapfile -t news_files < <(collect_news_files)

    for news_file in "${news_files[@]}"; do
        if [[ -f "${news_file}" ]]; then
            local symbol
            symbol=$(basename "${news_file}" | sed "s/-${TODAY}.md//")
            local news_content
            news_content=$(<"${news_file}")
            news_data="${news_data}

### ${symbol} æ–°è
${news_content}"
        fi
    done

    # ç”Ÿæˆå®Œæ•´ Prompt
    cat > "${PROMPT_FILE}" <<EOF
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å¸‚å ´æƒ…å ±åˆ†æå¸«,æ“…é•·è§£è®€å…¨çƒå¸‚å ´æ•¸æ“šå’Œæ–°è,æä¾›æ·±åº¦å¸‚å ´æ´å¯Ÿã€‚

## ğŸ“‹ åˆ†æä»»å‹™

è«‹æ ¹æ“šä»¥ä¸‹ä»Šæ—¥å¸‚å ´æ•¸æ“š,ç”Ÿæˆä¸€ä»½å®Œæ•´çš„**å¸‚å ´æƒ…å ±åˆ†æå ±å‘Š**ã€‚

### æ ¸å¿ƒè¦æ±‚:
1. **å¸‚å ´è¶¨å‹¢åˆ†æ**: è­˜åˆ¥å…¨çƒå¸‚å ´çš„ä¸»è¦è¶¨å‹¢å’Œé©…å‹•å› ç´ 
2. **æ–°èå½±éŸ¿è©•ä¼°**: æ·±åº¦è§£è®€é‡è¦æ–°èå°å¸‚å ´çš„æ½›åœ¨å½±éŸ¿
3. **æŒå€‰è¡¨ç¾åˆ†æ**: è©•ä¼°æŒè‚¡è¡¨ç¾ä¸¦æä¾›æ“ä½œå»ºè­°
4. **é¢¨éšªèˆ‡æ©Ÿæœƒ**: è­˜åˆ¥ç•¶å‰å¸‚å ´é¢¨éšªå’ŒæŠ•è³‡æ©Ÿæœƒ
5. **å¯åŸ·è¡Œå»ºè­°**: æä¾›å…·é«”ã€å¯æ“ä½œçš„æŠ•è³‡ç­–ç•¥

### å ±å‘Šé¢¨æ ¼:
- å°ˆæ¥­ä½†æ˜“æ‡‚
- æ•¸æ“šé©…å‹•,æ´å¯Ÿç‚ºå…ˆ
- çµæ§‹æ¸…æ™°,é‡é»çªå‡º
- é¿å…æ¨¡ç³Šå»ºè­°,æä¾›å…·é«”æ–¹å‘

---

## ğŸ“Š ä»Šæ—¥å¸‚å ´æ•¸æ“š

### å…¨çƒå¸‚å ´æŒ‡æ•¸
\`\`\`markdown
${indices_data}
\`\`\`

### æŒå€‰è‚¡ç¥¨åƒ¹æ ¼
\`\`\`markdown
${prices_data}
\`\`\`

### å¸‚å ´æ–°è
\`\`\`markdown
${news_data}
\`\`\`

---

## ğŸ“„ å ±å‘Šçµæ§‹

è«‹æŒ‰ç…§ä»¥ä¸‹çµæ§‹ç”Ÿæˆå ±å‘Š:

# ğŸ“ˆ å¸‚å ´æƒ…å ±åˆ†æ - ${TODAY}

> **å ±å‘Šç”Ÿæˆæ™‚é–“**: $(date +"%Y-%m-%d %H:%M UTC")
> **åˆ†æå¼•æ“**: Market Intelligence System (Claude CLI)
> **å ±å‘Šé¡å‹**: æ¯æ—¥å¸‚å ´æƒ…å ±

---

## ğŸ“Š åŸ·è¡Œæ‘˜è¦

### å¸‚å ´æ¦‚æ³
[ç”¨ 2-3 æ®µæ–‡å­—ç¸½çµä»Šæ—¥å…¨çƒå¸‚å ´è¡¨ç¾,åŒ…å«:]
- ä¸»è¦å¸‚å ´è¶¨å‹¢ (ç¾è‚¡ã€äºè‚¡ã€æ­è‚¡)
- é—œéµé©…å‹•å› ç´ 
- å¸‚å ´æƒ…ç·’æŒ‡æ¨™ (VIX)
- é‡è¦äº‹ä»¶æˆ–æ•¸æ“š

### é—œéµæ•¸æ“š

| æŒ‡æ¨™ | æ•¸å€¼ | è®ŠåŒ– | ç‹€æ…‹ |
|------|------|------|------|
| S&P 500 | X,XXX.XX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |
| Nasdaq | XX,XXX.XX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |
| VIX | XX.XX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |
| å°è‚¡åŠ æ¬Š | XX,XXX.XX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |
| é»ƒé‡‘ | \$X,XXX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |

### å¸‚å ´æƒ…ç·’è©•ä¼°

| é¡åˆ¥ | è©•åˆ† (1-10) | èªªæ˜ |
|------|-------------|------|
| æ•´é«”å¸‚å ´æƒ…ç·’ | X | ç°¡çŸ­èªªæ˜ |
| ç§‘æŠ€è‚¡æƒ…ç·’ | X | ç°¡çŸ­èªªæ˜ |
| æ³¢å‹•æ€§é¢¨éšª | X | ç°¡çŸ­èªªæ˜ |

---

## ğŸŒ å…¨çƒå¸‚å ´åˆ†æ

### ç¾åœ‹å¸‚å ´ ğŸ‡ºğŸ‡¸

**ä¸»è¦æŒ‡æ•¸è¡¨ç¾**

| æŒ‡æ•¸ | æ”¶ç›¤åƒ¹ | æ¼²è·Œå¹… | æŠ€è¡“ç‹€æ…‹ |
|------|--------|--------|----------|
| S&P 500 | X,XXX.XX | +X.XX% | æè¿° |
| Nasdaq | XX,XXX.XX | +X.XX% | æè¿° |
| Dow Jones | XX,XXX.XX | +X.XX% | æè¿° |

**å¸‚å ´åˆ†æ**:
[æ·±å…¥åˆ†æç¾åœ‹å¸‚å ´çš„è¡¨ç¾,åŒ…å«:]
- ä¸»è¦é©…å‹•å› ç´ 
- ç”¢æ¥­è¼ªå‹•æƒ…æ³
- æŠ€è¡“é¢é—œéµæ°´å¹³
- å¾Œå¸‚å±•æœ›

### äºæ´²å¸‚å ´ ğŸŒ

**ä¸»è¦å¸‚å ´è¡¨ç¾**

| å¸‚å ´ | æŒ‡æ•¸ | æ”¶ç›¤åƒ¹ | æ¼²è·Œå¹… |
|------|------|--------|--------|
| ğŸ‡¹ğŸ‡¼ å°ç£ | åŠ æ¬ŠæŒ‡æ•¸ | XX,XXX.XX | +X.XX% |
| ğŸ‡¯ğŸ‡µ æ—¥æœ¬ | æ—¥ç¶“225 | XX,XXX.XX | +X.XX% |
| ğŸ‡°ğŸ‡· éŸ“åœ‹ | KOSPI | X,XXX.XX | +X.XX% |

**å¸‚å ´åˆ†æ**:
[åˆ†æäºæ´²å¸‚å ´è¶¨å‹¢å’Œé—œéµå› ç´ ]

### æ­æ´²å¸‚å ´ ğŸ‡ªğŸ‡º

**å¸‚å ´åˆ†æ**:
[ç°¡è¦åˆ†ææ­æ´²å¸‚å ´]

---

## ğŸ’¼ æŒå€‰è‚¡ç¥¨åˆ†æ

### æ•´é«”è¡¨ç¾

| åˆ†é¡ | æ•¸é‡ | å¹³å‡æ¼²è·Œ | èªªæ˜ |
|------|------|----------|------|
| å¼·å‹¢ä¸Šæ¼² (>+2%) | X æª” | +X.XX% | æ¦‚è¿° |
| ç©©å¥ä¸Šæ¼² (+0%~+2%) | X æª” | +X.XX% | æ¦‚è¿° |
| è¼•å¾®ä¸‹è·Œ (0%~-2%) | X æª” | -X.XX% | æ¦‚è¿° |
| é‡å¤§è™§æ (<-2%) | X æª” | -X.XX% | æ¦‚è¿° |

### é‡é»æŒè‚¡åˆ†æ

[é‡å°è¡¨ç¾çªå‡ºçš„è‚¡ç¥¨ (æ¼²è·Œå¹… > 2%) é€²è¡Œè©³ç´°åˆ†æ:]

#### ğŸ“ˆ TICKER - å…¬å¸åç¨± (+X.XX%)

**åƒ¹æ ¼è³‡è¨Š**:
- æ”¶ç›¤åƒ¹: \$XXX.XX
- è®ŠåŒ–: +X.XX% (+\$X.XX)
- ç•¶æ—¥å€é–“: \$XXX.XX - \$XXX.XX

**åˆ†æ**:
[çµåˆæ–°èå’Œå¸‚å ´æ•¸æ“š,æ·±å…¥åˆ†ææ¼²è·ŒåŸå› ]

**æ“ä½œå»ºè­°**:
- **å»ºè­°**: æŒæœ‰ / åŠ ç¢¼ / æ¸›ç¢¼ / è§€æœ›
- **ç†ç”±**: å…·é«”èªªæ˜
- **ç›®æ¨™åƒ¹**: \$XXX.XX (å¦‚é©ç”¨)

---

## ğŸ“° é‡è¦æ–°èè§£è®€

[æŒ‰ä¸»é¡Œæˆ–ç”¢æ¥­åˆ†é¡,æ·±å…¥è§£è®€å½±éŸ¿å¸‚å ´çš„é‡è¦æ–°è:]

### ç§‘æŠ€ç”¢æ¥­

#### æ–°èæ¨™é¡Œ
[æ·±åº¦åˆ†ææ–°èå…§å®¹ã€å¸‚å ´å½±éŸ¿ã€æŠ•è³‡å•Ÿç¤º]

### å…¶ä»–ç”¢æ¥­

#### æ–°èæ¨™é¡Œ
[åŒä¸Š]

---

## âš ï¸ é¢¨éšªèˆ‡æ©Ÿæœƒ

### å¸‚å ´é¢¨éšª

1. **é¢¨éšª1**: è©³ç´°èªªæ˜
2. **é¢¨éšª2**: è©³ç´°èªªæ˜

### æŠ•è³‡æ©Ÿæœƒ

1. **æ©Ÿæœƒ1**: è©³ç´°èªªæ˜
2. **æ©Ÿæœƒ2**: è©³ç´°èªªæ˜

### VIX ææ…ŒæŒ‡æ•¸åˆ†æ

- **ç•¶å‰å€¼**: XX.XX
- **è®ŠåŒ–**: Â±X.XX%
- **è§£è®€**: [åˆ†æå¸‚å ´æƒ…ç·’]

---

## ğŸ’¡ æŠ•è³‡ç­–ç•¥å»ºè­°

### çŸ­æœŸç­–ç•¥ (1-2é€±)

**å¸‚å ´è§€é»**: [ç¸½çµçŸ­æœŸçœ‹æ³•]

**å…·é«”å»ºè­°**:
1. **å»ºè­°1**: è©³ç´°èªªæ˜æ“ä½œæ–¹å‘å’Œæ¢ä»¶
2. **å»ºè­°2**: è©³ç´°èªªæ˜

**è§¸ç™¼å¼æŒ‡ä»¤**:
- å¦‚æœ XXX,å‰‡åŸ·è¡Œ YYY æ“ä½œ

### ä¸­é•·æœŸç­–ç•¥

**é…ç½®å»ºè­°**: [èªªæ˜é…ç½®æ–¹å‘]

---

## ğŸ”® å¾Œå¸‚å±•æœ›

### é—œéµå‚¬åŒ–åŠ‘

**æœªä¾†ä¸€é€±é—œæ³¨**:
1. äº‹ä»¶1: æ™‚é–“ã€é æœŸå½±éŸ¿
2. äº‹ä»¶2: æ™‚é–“ã€é æœŸå½±éŸ¿

### æƒ…å¢ƒåˆ†æ

#### æ¨‚è§€æƒ…å¢ƒ (æ©Ÿç‡: XX%)
[æ¢ä»¶ã€é æœŸå½±éŸ¿ã€ç­–ç•¥]

#### åŸºæº–æƒ…å¢ƒ (æ©Ÿç‡: XX%)
[åŒä¸Š]

#### æ‚²è§€æƒ…å¢ƒ (æ©Ÿç‡: XX%)
[åŒä¸Š]

---

## âœ… è¡Œå‹•æ¸…å–®

### ç«‹å³åŸ·è¡Œ (æœ¬é€±)

- [ ] **è¡Œå‹•1**: å…·é«”æè¿°
- [ ] **è¡Œå‹•2**: å…·é«”æè¿°

### ä¸­æœŸè¿½è¹¤

- [ ] **è¡Œå‹•1**: å…·é«”æè¿°

---

## âš ï¸ å…è²¬è²æ˜

æœ¬å ±å‘Šåƒ…ä¾›åƒè€ƒ,ä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚æŠ•è³‡æœ‰é¢¨éšª,è«‹æ ¹æ“šè‡ªèº«æƒ…æ³åšå‡ºç¨ç«‹æ±ºç­–ã€‚

---

**å ±å‘Šè£½ä½œ**: Market Intelligence System
**åˆ†æå¼•æ“**: Claude CLI
**æ•¸æ“šä¾†æº**: Yahoo Finance
**å ±å‘Šç‰ˆæœ¬**: v1.0

---

è«‹ç›´æ¥é–‹å§‹ç”Ÿæˆå®Œæ•´çš„å¸‚å ´æƒ…å ±åˆ†æå ±å‘Š,å¾æ¨™é¡Œé–‹å§‹,ä¸è¦æœ‰ä»»ä½•å‰ç½®èªªæ˜æˆ–è©¢å•ã€‚
EOF

    echo -e "${GREEN}   âœ… Prompt å·²ç”Ÿæˆ (${PROMPT_FILE})${NC}"
    echo ""
}

run_claude_analysis() {
    echo -e "${BLUE}ğŸ§  èª¿ç”¨ Claude CLI é€²è¡Œå¸‚å ´åˆ†æ...${NC}"
    echo -e "${YELLOW}   é€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜,è«‹ç¨å€™...${NC}"
    echo ""

    # ç¢ºä¿åˆ†æç›®éŒ„å­˜åœ¨
    mkdir -p "${ANALYSIS_DIR}"

    # èª¿ç”¨ Claude CLI
    # ä½¿ç”¨äº’å‹•æ¨¡å¼,é€é stdin å‚³é prompt
    if cat "${PROMPT_FILE}" | "${CLAUDE_BIN}" > "${ANALYSIS_OUTPUT}" 2>&1; then
        echo -e "${GREEN}   âœ… åˆ†æå®Œæˆ!${NC}"
        echo ""
    else
        echo -e "${RED}   âŒ åˆ†æå¤±æ•—${NC}"
        echo -e "${YELLOW}   è«‹æª¢æŸ¥ Claude CLI æ˜¯å¦å·²ç™»å…¥: claude login${NC}"
        exit 1
    fi
}

show_results() {
    echo -e "${BLUE}============================================================${NC}"
    echo -e "${GREEN}ğŸ“„ åˆ†æå ±å‘Šå·²ä¿å­˜è‡³:${NC}"
    echo -e "${GREEN}   ${ANALYSIS_OUTPUT}${NC}"
    echo -e "${BLUE}============================================================${NC}"
    echo ""

    # é¡¯ç¤ºå ±å‘Šå‰ 30 è¡Œé è¦½
    echo -e "${BLUE}ğŸ“‹ å ±å‘Šé è¦½ (å‰ 30 è¡Œ):${NC}"
    echo -e "${BLUE}------------------------------------------------------------${NC}"
    head -n 30 "${ANALYSIS_OUTPUT}"
    echo -e "${BLUE}------------------------------------------------------------${NC}"
    echo ""
    echo -e "${GREEN}ğŸ’¡ æŸ¥çœ‹å®Œæ•´å ±å‘Š: cat ${ANALYSIS_OUTPUT}${NC}"
    echo ""
}

cleanup() {
    # æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
    rm -f "${PROMPT_FILE}"
}

###############################################################################
# ä¸»ç¨‹å¼
###############################################################################

main() {
    print_header
    check_dependencies
    check_data_files
    generate_analysis_prompt
    run_claude_analysis
    show_results
    cleanup

    echo -e "${GREEN}âœ… æ¯æ—¥å¸‚å ´åˆ†æå®Œæˆ!${NC}"
    echo ""
}

# åŸ·è¡Œä¸»ç¨‹å¼
main "$@"
